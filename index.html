<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log√≠stica Combust√≠veis GO - Gest√£o Avan√ßada</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <style>
        :root { --primary: #1a73e8; --success: #2e7d32; --danger: #d32f2f; --warning: #f57c00; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; background: #eceff1; }
        
        /* Sidebar Profissional */
        .sidebar { width: 450px; background: #fff; padding: 20px; box-shadow: 4px 0 15px rgba(0,0,0,0.1); overflow-y: auto; z-index: 1000; }
        #map { flex-grow: 1; }

        .section-title { font-size: 0.8rem; font-weight: 800; color: #546e7a; text-transform: uppercase; border-bottom: 2px solid #eee; margin: 15px 0 10px 0; padding-bottom: 5px; display: flex; align-items: center; gap: 5px; }

        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .field { margin-bottom: 12px; }
        .field label { font-size: 0.75rem; font-weight: 600; color: #455a64; display: block; margin-bottom: 4px; }
        .input-std { width: 100%; height: 40px; border-radius: 6px; border: 1px solid #cfd8dc; padding: 0 10px; box-sizing: border-box; font-size: 0.9rem; }
        
        .btn-main { width: 100%; height: 50px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; margin-top: 10px; text-transform: uppercase; transition: 0.3s; }
        .bg-calc { background: var(--primary); }
        .bg-calc:hover { background: #1557b0; }

        /* Painel de Resultados DRE */
        .dre-container { background: #263238; color: #fff; border-radius: 12px; padding: 15px; margin-top: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .dre-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #37474f; font-size: 0.9rem; }
        .dre-row.total { border-bottom: none; padding-top: 15px; font-weight: bold; font-size: 1.2rem; color: #81c784; }
        .val-red { color: #ff8a80; }

        .ponto-item { background: #f8f9fa; border: 1px solid #dee2e6; padding: 8px; border-radius: 6px; margin-bottom: 5px; font-size: 0.8rem; display: flex; justify-content: space-between; }
        
        @media (max-width: 768px) { body { flex-direction: column; } .sidebar { width: 100%; height: 50vh; } }
    </style>
</head>
<body>

<div class="sidebar">
    <div style="text-align: center; margin-bottom: 20px;">
        <h2 style="margin:0; color: var(--primary);">Master Log <span style="font-weight: 300;">PRO</span></h2>
        <small>Transporte de Combust√≠veis e Cargas Gran√©is</small>
    </div>

    <div class="section-title">üöõ Configura√ß√£o do Ve√≠culo & Custo</div>
    <div class="grid-inputs">
        <div class="field">
            <label>Diesel (R$/Litro)</label>
            <input type="number" id="precoDiesel" class="input-std" value="5.98" step="0.01">
        </div>
        <div class="field">
            <label>M√©dia (KM/L)</label>
            <input type="number" id="mediaVeiculo" class="input-std" value="2.1" step="0.1">
        </div>
        <div class="field">
            <label>Comiss√£o (%)</label>
            <input type="number" id="comissao" class="input-std" value="12">
        </div>
        <div class="field">
            <label>N¬∫ de Eixos (Ped√°gio)</label>
            <select id="eixos" class="input-std">
                <option value="3">3 Eixos (Trucado)</option>
                <option value="7">7 Eixos (Bitruck/Vanderleia)</option>
                <option value="9" selected>9 Eixos (Bitrem)</option>
            </select>
        </div>
    </div>

    <div class="section-title">üìç Destinos & Favoritos</div>
    <div class="field">
        <input type="text" id="busca" class="input-std" placeholder="Pesquisar Cidade ou Cliente..." oninput="pesquisar()">
        <div id="sugestoes" style="background:white; border:1px solid #ddd; display:none; max-height:100px; overflow-y:auto; border-radius:4px;"></div>
    </div>
    <div class="grid-inputs">
        <button class="btn-std" style="background:#fbc02d; border:none; border-radius:6px; cursor:pointer; font-weight:bold; font-size:0.7rem; height:35px;" onclick="document.getElementById('fileInput').click()">üìÇ IMPORTAR FAVORITOS</button>
        <input type="file" id="fileInput" style="display:none;" accept=".json">
        <button class="btn-std" style="background:#546e7a; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:0.7rem; height:35px;" onclick="limparTudo()">üóëÔ∏è LIMPAR ROTA</button>
    </div>

    <div id="listaAtiva" style="margin-top:10px;"></div>

    <button class="btn-main bg-calc" onclick="calcularTudo()">‚öôÔ∏è Calcular Or√ßamento Avan√ßado</button>

    <div id="painelDRE" class="dre-container" style="display: none;">
        <div style="text-align: center; color: #90a4ae; font-size: 0.7rem; margin-bottom: 10px;">DEMONSTRATIVO DE RESULTADO (ESTIMADO)</div>
        <div class="dre-row"><span>Dist√¢ncia (com margem):</span> <span id="resDist">0 km</span></div>
        <div class="dre-row"><span>Frete Bruto (ANTT Combust√≠vel):</span> <span id="resBruto">R$ 0,00</span></div>
        <div class="dre-row"><span>Gasto Diesel + Arla:</span> <span class="val-red" id="resDiesel">- R$ 0,00</span></div>
        <div class="dre-row"><span>Ped√°gios Estimados:</span> <span class="val-red" id="resPedagio">- R$ 0,00</span></div>
        <div class="dre-row"><span>Comiss√£o Motorista:</span> <span class="val-red" id="resComissao">- R$ 0,00</span></div>
        <div class="dre-row total"><span>LUCRO L√çQUIDO DA VIAGEM:</span> <span id="resLucro">R$ 0,00</span></div>
        <button class="btn-main" style="background:#25d366; margin-top:15px; height:40px;" onclick="enviarZap()">üì± Enviar Or√ßamento ao Cliente</button>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
    // In√≠cio em Goi√°s
    var map = L.map('map').setView([-16.68, -49.25], 7);
    L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}').addTo(map);

    var pontos = [];
    var marcadores = [];
    var routingControl = null;

    // Simula√ß√£o de Base de Ped√°gios por Eixo (Estimativa por KM em rodovias concedidas de GO/SP/MG)
    const CUSTO_PEDAGIO_POR_KM_EIXO = 0.08; 

    function pesquisar() {
        let q = document.getElementById('busca').value;
        if (q.length < 3) return;
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&countrycodes=br&limit=5`)
            .then(res => res.json()).then(data => {
                let html = '';
                data.forEach(item => {
                    html += `<div style="padding:8px; border-bottom:1px solid #eee; cursor:pointer; font-size:0.8rem" onclick="adicionar('${item.lat}','${item.lon}','${item.display_name}')">${item.display_name}</div>`;
                });
                document.getElementById('sugestoes').innerHTML = html;
                document.getElementById('sugestoes').style.display = 'block';
            });
    }

    function adicionar(lat, lon, nome) {
        pontos.push({ latlng: L.latLng(lat, lon), nome: nome });
        document.getElementById('busca').value = '';
        document.getElementById('sugestoes').style.display = 'none';
        renderLista();
    }

    function renderLista() {
        let html = '';
        marcadores.forEach(m => map.removeLayer(m));
        marcadores = [];
        pontos.forEach((p, i) => {
            html += `<div class="ponto-item"><span>${i==0?'üö©':'üìç'} ${p.nome.substring(0,30)}</span><b onclick="remover(${i})" style="color:red; cursor:pointer">‚úï</b></div>`;
            marcadores.push(L.marker(p.latlng).addTo(map));
        });
        document.getElementById('listaAtiva').innerHTML = html;
    }

    function calcularTudo() {
        if (pontos.length < 2) return alert("Defina origem e destino.");
        
        if (routingControl) map.removeControl(routingControl);

        routingControl = L.Routing.control({
            waypoints: pontos.map(p => p.latlng),
            router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', profile: 'car' }),
            lineOptions: { styles: [{ color: '#1a73e8', weight: 6 }] },
            addWaypoints: false, show: false
        }).on('routesfound', function(e) {
            let kmReal = e.routes[0].summary.totalDistance / 1000;
            let kmMargem = kmReal * 1.07; // 7% margem bitruck
            
            // 1. C√ÅLCULO DE FRETE (Simula√ß√£o Tabela ANTT Granel L√≠quido/Combust√≠vel)
            // Valor aproximado: R$ 6,50 por KM para Bitrem em Goi√°s
            let valorFreteKm = 6.80; 
            let bruto = kmMargem * valorFreteKm;

            // 2. CUSTO DIESEL + ARLA
            let consumoL = kmMargem / parseFloat(document.getElementById('mediaVeiculo').value);
            let custoDiesel = consumoL * parseFloat(document.getElementById('precoDiesel').value);
            let custoArla = custoDiesel * 0.05; // Estimativa 5% do valor do diesel

            // 3. PED√ÅGIO (Estimado por eixo e dist√¢ncia em rodovias principais)
            let numEixos = parseInt(document.getElementById('eixos').value);
            let pedagioTotal = (kmMargem * CUSTO_PEDAGIO_POR_KM_EIXO) * (numEixos / 2);

            // 4. COMISS√ÉO
            let comissaoVal = bruto * (parseFloat(document.getElementById('comissao').value) / 100);

            // 5. RESULTADO FINAL
            let lucro = bruto - custoDiesel - custoArla - pedagioTotal - comissaoVal;

            // EXIBIR NO PAINEL DRE
            document.getElementById('resDist').innerText = kmMargem.toFixed(2) + " KM";
            document.getElementById('resBruto').innerText = "R$ " + bruto.toLocaleString('pt-BR', {minimumFractionDigits:2});
            document.getElementById('resDiesel').innerText = "- R$ " + (custoDiesel + custoArla).toLocaleString('pt-BR', {minimumFractionDigits:2});
            document.getElementById('resPedagio').innerText = "- R$ " + pedagioTotal.toLocaleString('pt-BR', {minimumFractionDigits:2});
            document.getElementById('resComissao').innerText = "- R$ " + comissaoVal.toLocaleString('pt-BR', {minimumFractionDigits:2});
            document.getElementById('resLucro').innerText = "R$ " + lucro.toLocaleString('pt-BR', {minimumFractionDigits:2});
            
            document.getElementById('painelDRE').style.display = 'block';
            map.fitBounds(L.latLngBounds(pontos.map(p => p.latlng)));
        }).addTo(map);
    }

    function remover(i) { pontos.splice(i, 1); renderLista(); }
    function limparTudo() { pontos = []; renderLista(); document.getElementById('painelDRE').style.display='none'; if(routingControl) map.removeControl(routingControl); }

    function enviarZap() {
        let texto = `*COTA√á√ÉO DE FRETE PROFISSIONAL*%0A` +
                    `üõ£Ô∏è Dist√¢ncia: ${document.getElementById('resDist').innerText}%0A` +
                    `üí∞ *VALOR DO FRETE: ${document.getElementById('resBruto').innerText}*%0A` +
                    `üöõ Carga: Granel L√≠quido / Combust√≠veis%0A` +
                    `üìç Origem/Destino via Rodovias Principais.`;
        window.open(`https://api.whatsapp.com/send?text=${texto}`);
    }
</script>
</body>
</html>
