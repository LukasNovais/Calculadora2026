<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log√≠stica Pro - Entradas Inteligentes</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <style>
        :root { --primary: #1a73e8; --success: #1b5e20; --danger: #d93025; --field-height: 46px; }
        
        body { font-family: 'Roboto', Arial, sans-serif; margin: 0; background: #f1f3f4; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 100%; max-width: 400px; background: white; padding: 15px; box-shadow: 2px 0 12px rgba(0,0,0,0.15); z-index: 1001; overflow-y: auto; box-sizing: border-box; }
        #map { flex-grow: 1; z-index: 1; cursor: crosshair; }

        /* Padroniza√ß√£o de Campos e Bot√µes */
        .input-group { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        label { font-size: 0.75rem; font-weight: bold; color: #5f6368; display: block; margin-bottom: 4px; text-transform: uppercase; }

        .input-std, .btn-std {
            width: 100%; height: var(--field-height); box-sizing: border-box;
            border-radius: 8px; border: 1px solid #dadce0; margin-bottom: 8px;
            font-size: 0.9rem; display: flex; align-items: center; justify-content: center;
        }
        input { padding: 0 12px; outline-color: var(--primary); }
        .btn-std { border: none; color: white; font-weight: bold; cursor: pointer; gap: 8px; transition: filter 0.2s; }
        .btn-std:hover { filter: brightness(0.9); }

        /* Cores Espec√≠ficas */
        .bg-blue { background: #1a73e8; }
        .bg-plus { background: #8e24aa; }
        .bg-coord { background: #455a64; }
        .bg-calc { background: var(--success); width: 100%; height: 55px; font-size: 1.1rem; margin-top: 10px; }
        .bg-clear { background: #fff; color: var(--danger); border: 1px solid var(--danger); margin-top: 5px; }
        .bg-zap { background: #25d366; }

        /* Lista de Paradas */
        #lista { margin-top: 15px; }
        .ponto-card { 
            background: #fff; border: 1px solid #e8eaed; padding: 10px; border-radius: 8px; 
            margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
            border-left: 5px solid var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .ponto-card.origem { border-left-color: #f4b400; background: #fffde7; }

        .resumo-box { background: #e8f0fe; border-radius: 12px; padding: 15px; text-align: center; margin-top: 10px; border: 2px solid var(--primary); }
        .price-tag { font-size: 2rem; font-weight: bold; color: #174ea6; }

        @media (min-width: 768px) { body { flex-direction: row; } .sidebar { height: 100vh; } }
    </style>
</head>
<body>

<div class="sidebar">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <div style="display: flex; align-items: center; gap: 8px;">
            <img src="https://www.gstatic.com/images/branding/product/2x/maps_96dp.png" width="28">
            <h2 style="margin:0; font-size: 1.1rem; color: #3c4043;">Clone Maps v2</h2>
        </div>
        <input type="number" id="valorKm" style="width: 80px; height: 35px; text-align: center; border-radius: 5px; border: 1px solid #ccc;" value="4.50" title="Valor por KM">
    </div>

    <div class="input-group">
        <label>1. Pesquisa por Nome/Endere√ßo</label>
        <input type="text" id="busca" class="input-std" placeholder="Ex: Rondon√≥polis, MT" oninput="pesquisaInteligente()">
        <div id="sugestoes" style="background:white; border:1px solid #ddd; display:none; max-height:120px; overflow-y:auto; margin-bottom:10px; border-radius:8px;"></div>
    </div>

    <div class="input-group">
        <label>2. Por Coordenadas (Lat, Lon)</label>
        <input type="text" id="inputCoord" class="input-std" placeholder="-15.456, -54.789">
        <button class="btn-std bg-coord" onclick="adicionarPorCoord()">üìç ADICIONAR COORDENADA</button>
    </div>

    <div class="input-group">
        <label>3. Por Plus Code (C√≥digo Google)</label>
        <input type="text" id="inputPlus" class="input-std" placeholder="Ex: 87H2+9M">
        <button class="btn-std bg-plus" onclick="adicionarPorPlus()">‚úñÔ∏è ADICIONAR PLUS CODE</button>
    </div>

    <label class="input-std" style="background: #f8f9fa; cursor: pointer;">
        <input type="checkbox" id="retornoOrigem" checked style="margin-right:8px;"> IDA E VOLTA (RETORNO)
    </label>

    <button class="btn-std bg-calc" onclick="calcularRota()">üöÄ CALCULAR FRETE</button>
    <button class="btn-std bg-clear" onclick="limparLista()">üóëÔ∏è LIMPAR TODA A LISTA</button>

    <div id="lista"></div>

    <div id="resultado" class="resumo-box" style="display:none;">
        <div style="font-weight:bold;"><span id="dist">0</span> KM TOTAIS</div>
        <div class="price-tag">R$ <span id="preco">0,00</span></div>
        <button class="btn-std bg-zap" onclick="enviarZap()">ENVIAR WHATSAPP</button>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
    // Configura√ß√µes do Mapa (Sat√©lite + Ruas)
    var streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    var satelliteMap = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}');
    var map = L.map('map', { center: [-15.78, -47.92], zoom: 4, layers: [streetMap] });
    L.control.layers({"Mapa": streetMap, "Sat√©lite": satelliteMap}).addTo(map);

    var pontos = [];
    var marcadores = [];
    var routingControl = null;

    // Clique no mapa
    map.on('click', (e) => adicionar(e.latlng.lat, e.latlng.lng, "Marcado no Mapa"));

    // FUN√á√ïES DE ADI√á√ÉO
    async function pesquisaInteligente() {
        let q = document.getElementById('busca').value;
        if (q.length < 4) return;
        let res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&countrycodes=br&limit=5`);
        let data = await res.json();
        let html = '';
        data.forEach(item => {
            html += `<div style="padding:10px; border-bottom:1px solid #eee; cursor:pointer; font-size:0.8rem" onclick="adicionar('${item.lat}','${item.lon}','${item.display_name}')">${item.display_name}</div>`;
        });
        document.getElementById('sugestoes').innerHTML = html;
        document.getElementById('sugestoes').style.display = 'block';
    }

    function adicionarPorCoord() {
        let val = document.getElementById('inputCoord').value;
        let coords = val.match(/-?\d+\.\d+/g);
        if (coords && coords.length >= 2) {
            adicionar(coords[0], coords[1], "Coordenada Manual");
            document.getElementById('inputCoord').value = '';
        } else alert("Formato inv√°lido! Use: latitude, longitude");
    }

    async function adicionarPorPlus() {
        let code = document.getElementById('inputPlus').value;
        if (!code) return;
        // Simula√ß√£o de busca Plus Code via Nominatim (Plus codes funcionam melhor com API Key do Google, mas usamos geocoding como fallback)
        let res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(code)}`);
        let data = await res.json();
        if (data.length > 0) {
            adicionar(data[0].lat, data[0].lon, "Plus Code: " + code);
            document.getElementById('inputPlus').value = '';
        } else alert("Plus Code n√£o encontrado ou requer API Key do Google.");
    }

    function adicionar(lat, lon, nome) {
        let latlng = L.latLng(parseFloat(lat), parseFloat(lon));
        pontos.push({ id: Date.now().toString(), latlng: latlng, nome: nome });
        document.getElementById('busca').value = '';
        document.getElementById('sugestoes').style.display = 'none';
        renderizar();
    }

    function limparLista() {
        if(confirm("Deseja apagar todos os pontos e zerar o mapa?")) {
            pontos = [];
            if (routingControl) map.removeControl(routingControl);
            renderizar();
            document.getElementById('resultado').style.display = 'none';
        }
    }

    function remover(id) {
        pontos = pontos.filter(p => p.id !== id);
        renderizar();
    }

    function renderizar() {
        let html = '';
        marcadores.forEach(m => map.removeLayer(m));
        marcadores = [];

        pontos.forEach((p, i) => {
            let classe = i === 0 ? "ponto-card origem" : "ponto-card";
            let label = i === 0 ? "üèÅ <b>ORIGEM</b>" : `üìç Parada ${i}`;
            html += `<div class="${classe}" data-id="${p.id}">
                <div style="font-size:0.8rem;">${label}<br><small>${p.nome.substring(0,25)}...</small></div>
                <div style="display:flex; gap:4px;">
                    <button onclick="window.open('https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${p.latlng.lat},${p.latlng.lng}')" title="Street View" style="border:none; background:#f4b400; color:white; border-radius:4px; padding:4px 8px; cursor:pointer;">üëÄ</button>
                    <button onclick="remover('${p.id}')" style="color:var(--danger); border:none; background:none; font-size:1.1rem; cursor:pointer;">‚úï</button>
                </div>
            </div>`;
            let m = L.marker(p.latlng).addTo(map);
            marcadores.push(m);
        });
        document.getElementById('lista').innerHTML = html;
        Sortable.create(document.getElementById('lista'), { animation: 150, onEnd: () => {
            let novaOrdem = [];
            document.querySelectorAll('.ponto-card').forEach(item => {
                novaOrdem.push(pontos.find(p => p.id === item.dataset.id));
            });
            pontos = novaOrdem;
        }});
    }

    function calcularRota() {
        if (pontos.length < 2) return alert("Adicione ao menos 2 locais.");
        let rotaCalculo = [...pontos];
        if (document.getElementById('retornoOrigem').checked) rotaCalculo.push(pontos[0]);

        if (routingControl) map.removeControl(routingControl);

        routingControl = L.Routing.control({
            waypoints: rotaCalculo.map(p => p.latlng),
            addWaypoints: false, show: false,
            router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', profile: 'car' }),
            lineOptions: { styles: [{ color: '#1a73e8', weight: 6, opacity: 0.7 }] }
        }).on('routesfound', function(e) {
            let distKm = (e.routes[0].summary.totalDistance / 1000) * 1.07; // 7% margem bitruck
            let total = distKm * parseFloat(document.getElementById('valorKm').value);
            document.getElementById('dist').innerText = distKm.toFixed(2);
            document.getElementById('preco').innerText = total.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('resultado').style.display = 'block';
            map.fitBounds(L.latLngBounds(rotaCalculo.map(p => p.latlng)));
        }).addTo(map);
    }

    function enviarZap() {
        let msg = `*OR√áAMENTO DE FRETE*%0A` +
                  `üèÅ Paradas: ${pontos.length}%0A` +
                  `üõ£Ô∏è Dist√¢ncia: ${document.getElementById('dist').innerText} KM%0A` +
                  `üí∞ *VALOR TOTAL: R$ ${document.getElementById('preco').innerText}*`;
        window.open(`https://api.whatsapp.com/send?text=${msg}`);
    }
</script>
</body>
</html>
