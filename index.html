<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frete Pesado Pro - Rotas Principais</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <style>
        :root { --primary: #0d47a1; --success: #2e7d32; --danger: #c62828; --field-height: 48px; }
        
        body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; background: #f4f6f8; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 100%; max-width: 420px; background: white; padding: 15px; box-shadow: 3px 0 15px rgba(0,0,0,0.1); z-index: 1001; overflow-y: auto; box-sizing: border-box; border-right: 1px solid #ddd; }
        #map { flex-grow: 1; z-index: 1; cursor: crosshair; }

        label { font-size: 0.7rem; font-weight: 800; color: #444; display: block; margin: 10px 0 4px 0; text-transform: uppercase; letter-spacing: 0.5px; }

        .input-std, .btn-std {
            width: 100%; height: var(--field-height); box-sizing: border-box;
            border-radius: 6px; border: 1px solid #bfc1c3; margin-bottom: 8px;
            font-size: 0.95rem; display: flex; align-items: center; justify-content: center;
        }
        input { padding: 0 12px; font-weight: 500; }
        .btn-std { border: none; color: white; font-weight: bold; cursor: pointer; gap: 8px; }

        /* Estilo Bot√µes */
        .bg-search { background: #4285f4; }
        .bg-coord { background: #5f6368; }
        .bg-plus { background: #a142f4; }
        .bg-calc { background: var(--success); height: 55px; font-size: 1.1rem; margin-top: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .bg-clear { background: transparent; color: var(--danger); border: 1.5px solid var(--danger); margin-top: 10px; }
        .bg-zap { background: #25d366; width: 100%; }

        /* Lista de Paradas */
        .ponto-card { 
            background: #fdfdfd; border: 1px solid #e0e0e0; padding: 12px; border-radius: 8px; 
            margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
            border-left: 6px solid #4285f4;
        }
        .ponto-card.origem { border-left-color: #fbbc05; background: #fff9e6; }

        .resumo-box { background: #e3f2fd; border-radius: 12px; padding: 18px; text-align: center; margin-top: 15px; border: 2px solid #1976d2; }
        .price-tag { font-size: 2.2rem; font-weight: 900; color: #0d47a1; margin: 5px 0; }
        
        /* Badge para Rodovia */
        .badge-truck { background: #333; color: #fff; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; vertical-align: middle; margin-left: 5px; }

        @media (min-width: 768px) { body { flex-direction: row; } .sidebar { height: 100vh; } }
    </style>
</head>
<body>

<div class="sidebar">
    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
        <div style="display: flex; align-items: center; gap: 8px;">
            <img src="https://www.gstatic.com/images/branding/product/2x/maps_96dp.png" width="30">
            <h2 style="margin:0; font-size: 1.2rem;">Log√≠stica <span style="color:#4285f4">Pesada</span></h2>
        </div>
        <div title="Pre√ßo por KM">R$ <input type="number" id="valorKm" style="width: 60px; border:none; font-weight:bold; font-size: 1rem;" value="4.50"></div>
    </div>

    <label>üîç 1. Pesquisa Inteligente (Cidades/Bairros)</label>
    <input type="text" id="busca" class="input-std" placeholder="Digite o nome do lugar..." oninput="pesquisaInteligente()">
    <div id="sugestoes" style="background:white; border:1px solid #ddd; display:none; max-height:120px; overflow-y:auto; margin-bottom:10px; border-radius:4px; z-index:2000;"></div>

    <label>üåç 2. Coordenadas de GPS</label>
    <input type="text" id="inputCoord" class="input-std" placeholder="Ex: -16.32, -48.95">
    <button class="btn-std bg-coord" onclick="adicionarPorCoord()">INSERIR COORDENADA</button>

    <label>‚úñÔ∏è 3. Google Plus Code</label>
    <input type="text" id="inputPlus" class="input-std" placeholder="Ex: 87H2+9M Senador Canedo">
    <button class="btn-std bg-plus" onclick="adicionarPorPlus()">INSERIR PLUS CODE</button>

    <div style="margin-top: 15px; background: #fff3e0; padding: 10px; border-radius: 8px; border: 1px solid #ffe0b2;">
        <label style="margin:0; cursor:pointer; display: flex; align-items: center;">
            <input type="checkbox" id="retornoOrigem" checked style="width:18px; height:18px; margin-right:10px;"> 
            ROTA CIRCULAR (RETORNO √Ä BASE)
        </label>
    </div>

    <button class="btn-std bg-calc" onclick="calcularRota()">üöö CALCULAR ROTA PRINCIPAL</button>
    <button class="btn-std bg-clear" onclick="limparLista()">LIMPAR TUDO</button>

    <div id="lista"></div>

    <div id="resultado" class="resumo-box" style="display:none;">
        <div style="font-weight:bold; color:#555;">DIST√ÇNCIA (P√âS PESADOS): <span id="dist" style="color:#000">0</span> KM</div>
        <div class="price-tag">R$ <span id="preco">0,00</span></div>
        <button class="btn-std bg-zap" onclick="enviarZap()">ENVIAR VIA WHATSAPP</button>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
    // Inicializa√ß√£o do Mapa com Sat√©lite Google
    var streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    var satelliteMap = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}');
    var map = L.map('map', { center: [-15.78, -47.92], zoom: 4, layers: [streetMap] });
    L.control.layers({"Mapa": streetMap, "Sat√©lite": satelliteMap}, null, {collapsed: false}).addTo(map);

    var pontos = [];
    var marcadores = [];
    var routingControl = null;

    // Clique no mapa
    map.on('click', (e) => adicionar(e.latlng.lat, e.latlng.lng, "Ponto no Mapa"));

    async function pesquisaInteligente() {
        let q = document.getElementById('busca').value;
        if (q.length < 3) return;
        let res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&countrycodes=br&limit=5`);
        let data = await res.json();
        let html = '';
        data.forEach(item => {
            html += `<div style="padding:10px; border-bottom:1px solid #eee; cursor:pointer; font-size:0.8rem" onclick="adicionar('${item.lat}','${item.lon}','${item.display_name}')">${item.display_name}</div>`;
        });
        document.getElementById('sugestoes').innerHTML = html;
        document.getElementById('sugestoes').style.display = 'block';
    }

    function adicionarPorCoord() {
        let val = document.getElementById('inputCoord').value;
        let c = val.match(/-?\d+\.\d+/g);
        if (c && c.length >= 2) { adicionar(c[0], c[1], "Coord: " + val); document.getElementById('inputCoord').value = ''; }
    }

    async function adicionarPorPlus() {
        let code = document.getElementById('inputPlus').value;
        if (!code) return;
        let res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(code)}`);
        let data = await res.json();
        if (data.length > 0) { adicionar(data[0].lat, data[0].lon, "Plus: " + code); document.getElementById('inputPlus').value = ''; }
    }

    function adicionar(lat, lon, nome) {
        let latlng = L.latLng(parseFloat(lat), parseFloat(lon));
        pontos.push({ id: Date.now().toString(), latlng: latlng, nome: nome });
        document.getElementById('busca').value = '';
        document.getElementById('sugestoes').style.display = 'none';
        renderizar();
    }

    function limparLista() {
        if(confirm("Zerar todos os dados?")) {
            pontos = [];
            if (routingControl) map.removeControl(routingControl);
            renderizar();
            document.getElementById('resultado').style.display = 'none';
        }
    }

    function remover(id) {
        pontos = pontos.filter(p => p.id !== id);
        renderizar();
    }

    function renderizar() {
        let html = '';
        marcadores.forEach(m => map.removeLayer(m));
        marcadores = [];

        pontos.forEach((p, i) => {
            let classe = i === 0 ? "ponto-card origem" : "ponto-card";
            html += `<div class="${classe}" data-id="${p.id}">
                <div style="font-size:0.8rem;">${i === 0 ? 'üèÅ' : 'üìç'} <b>${i === 0 ? 'ORIGEM' : 'PARADA '+i}</b><br><small>${p.nome.substring(0,30)}...</small></div>
                <div style="display:flex; gap:6px;">
                    <button onclick="window.open('https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${p.latlng.lat},${p.latlng.lng}')" style="border:none; background:#fbbc05; color:white; border-radius:4px; padding:4px 8px; cursor:pointer;">üëÄ</button>
                    <button onclick="remover('${p.id}')" style="color:var(--danger); border:none; background:none; font-size:1.2rem; cursor:pointer;">‚úï</button>
                </div>
            </div>`;
            marcadores.push(L.marker(p.latlng).addTo(map));
        });
        document.getElementById('lista').innerHTML = html;
        Sortable.create(document.getElementById('lista'), { animation: 150, onEnd: reordenar });
    }

    function reordenar() {
        let nova = [];
        document.querySelectorAll('.ponto-card').forEach(item => nova.push(pontos.find(p => p.id === item.dataset.id)));
        pontos = nova;
    }

    function calcularRota() {
        if (pontos.length < 2) return alert("M√≠nimo de 2 pontos.");
        let rota = [...pontos];
        if (document.getElementById('retornoOrigem').checked) rota.push(pontos[0]);

        if (routingControl) map.removeControl(routingControl);

        // --- L√ìGICA DE ROTA PARA CAMINH√ÉO (AVENIDAS E RODOVIAS) ---
        routingControl = L.Routing.control({
            waypoints: rota.map(p => p.latlng),
            addWaypoints: false, show: false,
            router: L.Routing.osrmv1({
                serviceUrl: 'https://router.project-osrm.org/route/v1',
                profile: 'car', // Perfil de carro em OSRM prioriza vias pavimentadas sobre atalhos
                useHints: false
            }),
            lineOptions: { styles: [{ color: '#0d47a1', weight: 8, opacity: 0.8 }] }
        }).on('routesfound', function(e) {
            // Dist√¢ncia oficial + 8% para compensar trajetos de bitruck em trevos e acessos
            let distKm = (e.routes[0].summary.totalDistance / 1000) * 1.08; 
            let preco = distKm * parseFloat(document.getElementById('valorKm').value);
            
            document.getElementById('dist').innerText = distKm.toFixed(2);
            document.getElementById('preco').innerText = preco.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('resultado').style.display = 'block';
            map.fitBounds(L.latLngBounds(rota.map(p => p.latlng)));
        }).addTo(map);
    }

    function enviarZap() {
        let msg = `*CALCULO DE FRETE LOG√çSTICA PESADA*%0A%0A` +
                  `üõ£Ô∏è Dist√¢ncia Total: ${document.getElementById('dist').innerText} KM%0A` +
                  `üí∞ *VALOR TOTAL: R$ ${document.getElementById('preco').innerText}*%0A%0A` +
                  `_Rota calculada via Rodovias e Avenidas Principais (Truck/Bitruck)._`;
        window.open(`https://api.whatsapp.com/send?text=${msg}`);
    }
</script>
</body>
</html>
