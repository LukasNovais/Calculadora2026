<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frete Pesado Pro - Trucado & Bitruck</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <style>
        :root { 
            --primary: #1b5e20; 
            --accent: #0d47a1; 
            --danger: #b71c1c; 
            --field-height: 50px;
        }
        
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 100%; max-width: 400px; background: white; padding: 20px; box-shadow: 2px 0 15px rgba(0,0,0,0.1); z-index: 10; overflow-y: auto; box-sizing: border-box; }
        #map { flex-grow: 1; z-index: 1; }

        .input-standard, .btn-standard {
            width: 100%;
            height: var(--field-height);
            box-sizing: border-box;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ccc;
        }

        input[type="number"], input[type="text"] { padding: 0 15px; background: #fff; }

        .btn-standard { border: none; color: white; font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }

        .bg-green { background-color: var(--primary); }
        .bg-blue { background-color: var(--accent); }
        .bg-whatsapp { background-color: #25d366; }

        .toggle-container { background: #fff3e0; border: 1px solid #ffe0b2; cursor: pointer; font-weight: bold; font-size: 0.85rem; }

        #lista { margin-top: 5px; }
        .ponto-card { 
            background: #fff; border: 1px solid #ddd; padding: 12px; border-radius: 8px; 
            margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; 
            cursor: grab; border-left: 5px solid #ccc;
        }
        .ponto-card.origem { border-left-color: var(--accent); background: #e3f2fd; }

        .resumo { background: #fff; border: 2px solid var(--primary); border-radius: 12px; padding: 15px; text-align: center; margin-top: 10px; display: none; }
        .valor { font-size: 2.2rem; font-weight: bold; color: var(--primary); }

        @media (min-width: 768px) { body { flex-direction: row; } .sidebar { height: 100vh; } }
    </style>
</head>
<body>

<div class="sidebar">
    <div style="text-align:center; margin-bottom:15px;">
        <h3 style="margin:0; color:var(--accent);">üöõ ROTA PESADA</h3>
        <small style="color:#666;">Trucado | Bitruck | Rodovia</small>
    </div>

    <label style="font-size:0.7rem; font-weight:bold; color:#555;">VALOR POR KM (R$):</label>
    <input type="number" id="valorKm" class="input-standard" value="4.50" step="0.10">

    <label style="font-size:0.7rem; font-weight:bold; color:#555;">ADICIONAR LOCALIDADE:</label>
    <input type="text" id="busca" class="input-standard" placeholder="Pesquisar Cidade ou Endere√ßo..." oninput="buscarEndereco()">
    <div id="sugestoes" style="background:white; border:1px solid #eee; display:none; max-height:150px; overflow-y:auto; margin-bottom:10px; border-radius:8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>

    <button class="btn-standard bg-green" onclick="colarCoordenada()">üìç COLAR COORDENADA GOOGLE</button>

    <label class="input-standard toggle-container">
        <input type="checkbox" id="retornoOrigem" checked style="margin-right:10px;"> IDA E VOLTA (RETORNO √Ä BASE)
    </label>

    <button class="btn-standard bg-blue" onclick="otimizarECalcular()">‚ú® CALCULAR ROTA PARA CAMINH√ÉO</button>

    <div id="lista"></div>

    <div id="resultado" class="resumo">
        <div id="tipoRota" style="font-weight:bold; color:var(--accent); font-size:0.8rem; margin-bottom:5px;"></div>
        <div style="font-size: 0.9rem; color:#444;">Dist√¢ncia Total Estimada:</div>
        <strong><span id="dist">0</span> KM</strong>
        <div class="valor">R$ <span id="preco">0,00</span></div>
        <button class="btn-standard bg-whatsapp" onclick="enviarZap()">ENVIAR OR√áAMENTO VIA WHATSAPP</button>
    </div>

    <button onclick="window.location.reload()" style="width:100%; background:none; border:none; color:#999; margin-top:15px; cursor:pointer; text-decoration:underline; font-size:0.8rem;">Zerar Mapa e Dados</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
    var map = L.map('map').setView([-15.78, -47.92], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    var pontos = [];
    var routingControl = null;

    Sortable.create(document.getElementById('lista'), { animation: 150, onEnd: function() { reordenarManual(); } });

    async function buscarEndereco() {
        let q = document.getElementById('busca').value;
        if (q.length < 4) return;
        let res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&countrycodes=br&limit=5`);
        let data = await res.json();
        let html = '';
        data.forEach(item => {
            html += `<div style="padding:12px; border-bottom:1px solid #eee; cursor:pointer" onclick="adicionar('${item.lat}','${item.lon}','${item.display_name}')">${item.display_name}</div>`;
        });
        document.getElementById('sugestoes').innerHTML = html;
        document.getElementById('sugestoes').style.display = 'block';
    }

    async function colarCoordenada() {
        try {
            const texto = await navigator.clipboard.readText();
            const coords = texto.match(/-?\d+\.\d+/g);
            if (coords && coords.length >= 2) adicionar(coords[0], coords[1], "Localiza√ß√£o Rural/Coordenada");
        } catch (e) { alert("Acesso √† √°rea de transfer√™ncia negado."); }
    }

    function adicionar(lat, lon, nome) {
        let latlng = L.latLng(parseFloat(lat), parseFloat(lon));
        pontos.push({ id: Date.now().toString(), latlng: latlng, nome: nome });
        document.getElementById('busca').value = '';
        document.getElementById('sugestoes').style.display = 'none';
        renderizar();
    }

    function remover(id) {
        pontos = pontos.filter(p => p.id !== id);
        renderizar();
    }

    function reordenarManual() {
        let novaOrdem = [];
        document.querySelectorAll('.ponto-card').forEach(item => {
            novaOrdem.push(pontos.find(p => p.id === item.dataset.id));
        });
        pontos = novaOrdem;
    }

    function renderizar() {
        let html = '';
        pontos.forEach((p, i) => {
            let classe = i === 0 ? "ponto-card origem" : "ponto-card";
            let label = i === 0 ? "üöõ <b>BASE/CARGA</b>" : `üìç Parada ${i}`;
            html += `<div class="${classe}" data-id="${p.id}">
                <div>${label}<br><small>${p.nome.substring(0,30)}...</small></div>
                <button onclick="remover('${p.id}')" style="color:red; border:none; background:none; font-size:1.2rem; cursor:pointer;">‚úï</button>
            </div>`;
        });
        document.getElementById('lista').innerHTML = html;
    }

    function otimizarECalcular() {
        if (pontos.length < 2) return alert("Defina pelo menos a Origem e um Destino.");

        let rotaCalculo = [...pontos];
        if (document.getElementById('retornoOrigem').checked) {
            rotaCalculo.push(pontos[0]);
            document.getElementById('tipoRota').innerText = "ROTA CIRCULAR: IDA E VOLTA √Ä BASE";
        } else {
            document.getElementById('tipoRota').innerText = "ROTA LINEAR: APENAS IDA";
        }

        if (routingControl) map.removeControl(routingControl);

        // O motor OSRM (padr√£o) j√° prioriza rodovias em trajetos longos
        routingControl = L.Routing.control({
            waypoints: rotaCalculo.map(p => p.latlng),
            addWaypoints: false,
            draggableWaypoints: false,
            show: false,
            router: L.Routing.osrmv1({
                serviceUrl: 'https://router.project-osrm.org/route/v1',
                profile: 'car' // OSRM prioriza estradas principais para carros/caminh√µes leves
            }),
            lineOptions: { styles: [{ color: '#0d47a1', weight: 7, opacity: 0.8 }] }
        }).on('routesfound', function(e) {
            let distKm = e.routes[0].summary.totalDistance / 1000;
            
            // Para caminh√£o trucado/bitruck, a margem de seguran√ßa deve considerar
            // que o ve√≠culo n√£o faz manobras bruscas e percorre mais dist√¢ncia em acessos.
            let kmFinal = distKm * 1.08; 
            
            let vKm = parseFloat(document.getElementById('valorKm').value);
            let total = kmFinal * vKm;

            document.getElementById('dist').innerText = kmFinal.toFixed(2);
            document.getElementById('preco').innerText = total.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('resultado').style.display = 'block';
            map.fitBounds(L.latLngBounds(rotaCalculo.map(p => p.latlng)));
        }).addTo(map);
    }

    function enviarZap() {
        let msg = `*OR√áAMENTO DE FRETE PESADO*%0A%0A` +
                  `üèÅ Paradas Planejadas: ${pontos.length}%0A` +
                  `üõ£Ô∏è Dist√¢ncia Estimada: ${document.getElementById('dist').innerText} KM%0A` +
                  `üí∞ *VALOR TOTAL: R$ ${document.getElementById('preco').innerText}*%0A%0A` +
                  `_Configurado para ve√≠culo Trucado / Bitruck via Rodovias Pavimentadas._`;
        window.open(`https://api.whatsapp.com/send?text=${msg}`);
    }
</script>
</body>
</html>
