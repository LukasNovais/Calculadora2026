<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Log√≠stica Master Intelligence - Vers√£o Completa</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        :root { --primary: #1a237e; --accent: #00c853; --google-blue: #1a73e8; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: #f0f2f5; }
        
        /* Sidebar Larga para todos os campos */
        .sidebar { width: 450px; background: white; padding: 15px; box-shadow: 5px 0 15px rgba(0,0,0,0.2); overflow-y: auto; z-index: 1000; }
        #map { flex-grow: 1; cursor: crosshair; }

        .section { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
        .title { font-size: 0.75rem; font-weight: bold; color: #555; text-transform: uppercase; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .input-std { width: 100%; height: 38px; border: 1px solid #bdbdbd; border-radius: 4px; padding: 5px 10px; box-sizing: border-box; font-size: 13px; margin-bottom: 5px; }
        
        .btn { width: 100%; padding: 10px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 12px; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .bg-blue { background: var(--google-blue); color: white; }
        .bg-import { background: #fbbc04; color: black; }
        .bg-calc { background: var(--accent); color: white; font-size: 14px; height: 45px; }
        .bg-clear { background: #fff; color: #d32f2f; border: 1px solid #d32f2f; }

        /* Lista de Paradas */
        .ponto-card { background: #f8f9fa; border: 1px solid #ddd; padding: 8px; border-radius: 6px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; font-size: 12px; border-left: 5px solid var(--google-blue); }
        .ponto-card.origem { border-left-color: #fbbc04; }

        /* Painel Financeiro */
        .dre-box { background: #212121; color: #fff; border-radius: 8px; padding: 15px; margin-top: 10px; }
        .dre-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #444; font-size: 13px; }
        .lucro-val { font-size: 18px; color: #00e676; font-weight: bold; }

        #sugestoes { background: white; border: 1px solid #ccc; max-height: 150px; overflow-y: auto; display: none; }
        .fav-list { max-height: 100px; overflow-y: auto; background: #fffde7; border-radius: 4px; padding: 5px; font-size: 11px; margin-top: 5px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div style="text-align:center; padding-bottom:10px;">
        <img src="https://www.gstatic.com/images/branding/product/2x/maps_96dp.png" width="25">
        <h3 style="margin:0; display:inline; vertical-align:middle;"> Log√≠stica Intelligence Pro</h3>
    </div>

    <div class="section">
        <span class="title">‚≠ê Importa√ß√£o e Favoritos</span>
        <button class="btn bg-import" onclick="document.getElementById('fileInput').click()">üìÇ Importar JSON Google Takeout</button>
        <input type="file" id="fileInput" style="display:none;" accept=".json">
        <div id="meusFavoritos" class="fav-list" style="display:none;"></div>
    </div>

    <div class="section">
        <span class="title">üìç Informar Localiza√ß√£o</span>
        <label style="font-size:10px;">PESQUISA INTELIGENTE</label>
        <input type="text" id="busca" class="input-std" placeholder="Cidade, Posto ou Cliente..." oninput="pesquisar()">
        <div id="sugestoes"></div>
        
        <div class="grid">
            <div>
                <label style="font-size:10px;">COORDENADAS</label>
                <input type="text" id="inputCoord" class="input-std" placeholder="lat, lon">
            </div>
            <div>
                <label style="font-size:10px;">PLUS CODE</label>
                <input type="text" id="inputPlus" class="input-std" placeholder="Ex: 5VG5+XP">
            </div>
        </div>
        <div class="grid">
            <button class="btn bg-blue" onclick="addCoord()">Add Coords</button>
            <button class="btn bg-blue" onclick="addPlus()">Add Plus</button>
        </div>
    </div>

    <div class="section">
        <span class="title">‚öôÔ∏è Custos da Viagem (Combust√≠vel)</span>
        <div class="grid">
            <div class="field"><label style="font-size:10px;">DIESEL R$/L</label><input type="number" id="diesel" class="input-std" value="5.95"></div>
            <div class="field"><label style="font-size:10px;">M√âDIA CARG.</label><input type="number" id="mediaC" class="input-std" value="1.9"></div>
            <div class="field"><label style="font-size:10px;">M√âDIA VAZIO</label><input type="number" id="mediaV" class="input-std" value="2.8"></div>
            <div class="field"><label style="font-size:10px;">EIXOS (PED√ÅGIO)</label><input type="number" id="eixos" class="input-std" value="9"></div>
            <div class="field"><label style="font-size:10px;">COMISS√ÉO %</label><input type="number" id="comissao" class="input-std" value="12"></div>
            <div class="field"><label style="font-size:10px;">FRETE TOTAL R$</label><input type="number" id="freteProposto" class="input-std" placeholder="Bruto"></div>
        </div>
        <button class="btn bg-calc" onclick="calcularTudo()">üöö CALCULAR ROTA E RENTABILIDADE</button>
        <button class="btn bg-clear" onclick="limparTudo()">üóëÔ∏è LIMPAR TUDO</button>
    </div>

    <div id="listaAtiva"></div>

    <div id="resultadoDRE" class="dre-box" style="display:none;">
        <div class="dre-row"><span>KM Total (Ida/Volta):</span><span id="resKm">0</span></div>
        <div class="dre-row"><span>Diesel + Arla (Misto):</span><span id="resDiesel" style="color:#ff8a80;">R$ 0</span></div>
        <div class="dre-row"><span>Ped√°gio Est. (Eixos):</span><span id="resPedagio" style="color:#ff8a80;">R$ 0</span></div>
        <div class="dre-row"><span>Comiss√£o Motorista:</span><span id="resComissao" style="color:#ff8a80;">R$ 0</span></div>
        <div class="dre-row" style="border:none; margin-top:10px;"><span>LUCRO L√çQUIDO:</span><span id="resLucro" class="lucro-val">R$ 0</span></div>
        <button class="btn" style="background:#25d366; color:white; margin-top:10px;" onclick="enviarZap()">üì± Enviar no WhatsApp</button>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
    // Inicializa√ß√£o - Foco em Goi√°s (Goi√¢nia)
    var map = L.map('map').setView([-16.68, -49.25], 7);
    var streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    var satelliteMap = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}');
    
    streetMap.addTo(map);
    L.control.layers({"Mapa": streetMap, "Sat√©lite": satelliteMap}, null, {collapsed: false}).addTo(map);

    var pontos = [];
    var marcadores = [];
    var routingControl = null;

    // --- FUN√á√ÉO VOLTOU: CLICAR NO MAPA PARA ADICIONAR ---
    map.on('click', function(e) {
        adicionar(e.latlng.lat, e.latlng.lng, "Ponto Marcado no Mapa");
    });

    function pesquisar() {
        let q = document.getElementById('busca').value;
        if(q.length < 3) return;
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&countrycodes=br&limit=5`)
            .then(r => r.json()).then(data => {
                let h = '';
                data.forEach(i => h += `<div style="padding:8px; cursor:pointer; border-bottom:1px solid #eee; font-size:12px;" onclick="adicionar(${i.lat},${i.lon},'${i.display_name}')">${i.display_name}</div>`);
                document.getElementById('sugestoes').innerHTML = h;
                document.getElementById('sugestoes').style.display = 'block';
            });
    }

    function addCoord() {
        let v = document.getElementById('inputCoord').value;
        let c = v.match(/-?\d+\.\d+/g);
        if(c && c.length >= 2) adicionar(c[0], c[1], "Coordenada Manual");
    }

    function addPlus() {
        let code = document.getElementById('inputPlus').value;
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(code)}`)
            .then(r => r.json()).then(data => {
                if(data[0]) adicionar(data[0].lat, data[0].lon, "Plus Code: "+code);
            });
    }

    function adicionar(lat, lon, nome) {
        let latlng = L.latLng(parseFloat(lat), parseFloat(lon));
        pontos.push({ id: Date.now().toString(), latlng: latlng, nome: nome });
        document.getElementById('sugestoes').style.display = 'none';
        document.getElementById('busca').value = '';
        renderLista();
    }

    function renderLista() {
        let html = '';
        marcadores.forEach(m => map.removeLayer(m));
        marcadores = [];

        pontos.forEach((p, i) => {
            let classe = i === 0 ? "ponto-card origem" : "ponto-card";
            html += `<div class="${classe}" data-id="${p.id}">
                <span>${i==0?'üèÅ':'üìç'} ${p.nome.substring(0,25)}...</span>
                <div style="display:flex; gap:5px;">
                    <button onclick="window.open('https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${p.latlng.lat},${p.latlng.lng}')" style="border:none; background:#fbbc04; border-radius:3px; cursor:pointer;">üëÄ</button>
                    <button onclick="remover('${p.id}')" style="border:none; background:none; color:red; cursor:pointer; font-weight:bold;">‚úï</button>
                </div>
            </div>`;
            marcadores.push(L.marker(p.latlng).addTo(map));
        });
        document.getElementById('listaAtiva').innerHTML = html;
        Sortable.create(document.getElementById('listaAtiva'), { animation: 150, onEnd: reordenar });
    }

    function reordenar() {
        let nova = [];
        document.querySelectorAll('.ponto-card').forEach(el => {
            nova.push(pontos.find(p => p.id === el.dataset.id));
        });
        pontos = nova;
    }

    function calcularTudo() {
        if(pontos.length < 2) return alert("Adicione no m√≠nimo Origem e Destino");
        
        let rotaIdaVolta = [...pontos, pontos[0]]; // Estrat√©gia Ida e Volta

        if(routingControl) map.removeControl(routingControl);

        routingControl = L.Routing.control({
            waypoints: rotaIdaVolta.map(p => p.latlng),
            router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', profile: 'car' }),
            show: false, addWaypoints: false,
            lineOptions: { styles: [{ color: '#1a73e8', weight: 6 }] }
        }).on('routesfound', function(e) {
            let kmTotal = (e.routes[0].summary.totalDistance / 1000) * 1.05; // 5% margem manobra
            let kmIda = kmTotal / 2;

            // Diesel Misto (Ida Carregado / Volta Vazio)
            let litrosIda = kmIda / parseFloat(document.getElementById('mediaC').value);
            let litrosVolta = kmIda / parseFloat(document.getElementById('mediaV').value);
            let custoDiesel = (litrosIda + litrosVolta) * parseFloat(document.getElementById('diesel').value);
            
            // Ped√°gio Est. (10 centavos por km por par de eixos aprox)
            let pedagio = (kmTotal * 0.10) * (parseInt(document.getElementById('eixos').value) / 2);
            
            let freteBruto = parseFloat(document.getElementById('freteProposto').value) || 0;
            let comissao = freteBruto * (parseFloat(document.getElementById('comissao').value) / 100);
            let lucro = freteBruto - custoDiesel - pedagio - comissao;

            document.getElementById('resKm').innerText = kmTotal.toFixed(1) + " km";
            document.getElementById('resDiesel').innerText = "R$ " + custoDiesel.toFixed(2);
            document.getElementById('resPedagio').innerText = "R$ " + pedagio.toFixed(2);
            document.getElementById('resComissao').innerText = "R$ " + comissao.toFixed(2);
            document.getElementById('resLucro').innerText = "R$ " + lucro.toFixed(2);
            
            document.getElementById('resultadoDRE').style.display = 'block';
            map.fitBounds(L.latLngBounds(pontos.map(p => p.latlng)));
        }).addTo(map);
    }

    // Importa√ß√£o JSON Google
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function() {
            const data = JSON.parse(reader.result);
            const favs = data.features || data;
            let h = '';
            favs.forEach(f => {
                let n = f.properties?.name || f.name;
                let la = f.geometry?.coordinates[1] || f.latitude;
                let lo = f.geometry?.coordinates[0] || f.longitude;
                if(la) h += `<div class="fav-item" style="cursor:pointer; padding:3px;" onclick="adicionar(${la},${lo},'${n}')">‚≠ê ${n}</div>`;
            });
            document.getElementById('meusFavoritos').innerHTML = h;
            document.getElementById('meusFavoritos').style.display = 'block';
        };
        reader.readAsText(e.target.files[0]);
    });

    function remover(id) { pontos = pontos.filter(p => p.id !== id); renderLista(); }
    function limparTudo() { pontos = []; renderLista(); document.getElementById('resultadoDRE').style.display='none'; if(routingControl) map.removeControl(routingControl); }
    
    function enviarZap() {
        let msg = `*RELAT√ìRIO DE FRETE LOG√çSTICA*%0A` +
                  `üõ£Ô∏è Dist√¢ncia: ${document.getElementById('resKm').innerText}%0A` +
                  `üí∞ *LUCRO L√çQUIDO: ${document.getElementById('resLucro').innerText}*%0A` +
                  `‚õΩ Diesel Est: ${document.getElementById('resDiesel').innerText}`;
        window.open(`https://api.whatsapp.com/send?text=${msg}`);
    }
</script>
</body>
</html>
